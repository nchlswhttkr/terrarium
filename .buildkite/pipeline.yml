steps:
    - label: ":docker: Build and push server image"
      command: .buildkite/build.sh
      env:
          VAULT_ROLE_ID: 703f9e62-1225-507b-ab21-9b762f8db482

    - label: ":golang: Build custom release of Terraform"
      command:
          - git clone https://github.com/hashicorp/terraform.git
          - cd terraform
          - go get .
          - go get -u github.com/aws/aws-sdk-go
          - CGO_ENABLED=0 go build
          - cd ..
          - buildkite-agent artifact upload terraform/terraform
      plugins:
          - docker#v5.5.1:
                image: golang:1.20
                mount_buildkite_agent: true

    - wait

    - label: ":terraform: Deploy Terrarium"
      if: 'build.branch == "main"'
      command: .buildkite/deploy.sh
      env:
          VAULT_ROLE_ID: 703f9e62-1225-507b-ab21-9b762f8db482
